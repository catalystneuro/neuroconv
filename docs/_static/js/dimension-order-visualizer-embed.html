<link rel="stylesheet" href="../../_static/css/dimension-order-visualizer.css">
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- div for react root -->
<div id="dimension-order-visualizer-root"></div>

<script type="text/babel">
  const DimensionOrderVisualizer = () => {
    const [dimensionOrder, setDimensionOrder] = React.useState('ZCT');
    const [sequence, setSequence] = React.useState([]);

    // We fix these values here as they are all different among themselves
    // and small enough to visualize easily
    const zSize = 3;
    const cSize = 2;
    const tSize = 4;

    // Channel color palette used for visualization:
    // - Blue (#4A90B8): Primary channel color
    // - Orange (#D4845C): Secondary channel color
    const channelColors = ['#4A90B8', '#D4845C'];
    const channelNames = ['0', '1'];

    React.useEffect(() => {
      const generateSequence = () => {
        let result = [];
        const order = dimensionOrder.split('');
        const loopOrder = [...order].reverse();
        let index = 0;

        const generateFrames = (indices = {}, level = 0) => {
          if (level === order.length) {
            result.push({
              z: indices.Z,
              c: indices.C,
              t: indices.T,
              index: index++
            });
            return;
          }

          const dimension = loopOrder[level];
          const size = dimension === 'Z' ? zSize : dimension === 'C' ? cSize : tSize;

          for (let i = 0; i < size; i++) {
            const newIndices = { ...indices };
            newIndices[dimension] = i;
            generateFrames(newIndices, level + 1);
          }
        };

        generateFrames();
        return result;
      };

      setSequence(generateSequence());
    }, [dimensionOrder]);

    const frameSize = 60;
    const xSpacing = 70;

    const getDescription = (order) => {
      const descriptions = {
        'ZTC': 'Frames are stored with all Z-planes for one timepoint first, then the next timepoint, and finally switching to the next channel.',
        'ZCT': 'Frames are stored with all Z-planes for one channel first, then switching channels, and finally moving to the next timepoint.',
        'TZC': 'Frames are stored with all timepoints for one Z-plane first, then the next Z-plane, and finally switching to the next channel.',
        'TCZ': 'Frames are stored with all timepoints for one channel first, then switching channels, and finally changing Z-planes.',
        'CZT': 'Frames are stored with all channels for one Z-plane first, then the next Z-plane, and finally advancing to the next timepoint.',
        'CTZ': 'Frames are stored with all channels for one timepoint first, then the next timepoint, and finally changing Z-planes.'
      };
      return descriptions[order] || '';
    };

    return (
      <div className="visualizer-container">
        <h2 style={{textAlign: 'center', marginBottom: '1.5rem'}}>TIFF Frame Layout Visualizer</h2>

        <div className="dimension-selector">
          <label>Dimension Order:</label>
          <div className="button-group">
            {['ZTC', 'ZCT', 'TZC', 'TCZ', 'CZT', 'CTZ'].map(order => (
              <button
                key={order}
                onClick={() => setDimensionOrder(order)}
                className={`order-button ${dimensionOrder === order ? 'active' : ''}`}
              >
                {order}
              </button>
            ))}
          </div>
        </div>

        <div className="viz-section">
          <h3>Frame Layout: {dimensionOrder}</h3>

          <div className="description">
            {getDescription(dimensionOrder)}
          </div>

          <div style={{marginBottom: '1rem', display: 'flex', gap: '1.5rem', justifyContent: 'center', alignItems: 'center'}}>
            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <div style={{width: '20px', height: '20px', backgroundColor: channelColors[0], border: '1px solid #ccc'}}></div>
              <span>Channel 0</span>
            </div>
            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
              <div style={{width: '20px', height: '20px', backgroundColor: channelColors[1], border: '1px solid #ccc'}}></div>
              <span>Channel 1</span>
            </div>
          </div>

          // Display Frame Grid
          <div className="frame-display">
            <div className="depth-label-container">
              <span className="depth-label-text">Depth</span>
            </div>
            <div className="frame-grid-container">
              <div className="frame-grid-header">Frame Index on Disk</div>
              <div className="frame-grid">
                {sequence.map((frame, i) => (
                  <div
                    key={i}
                    className="frame-cell"
                    style={{
                      backgroundColor: channelColors[frame.c],
                      width: frameSize,
                      height: frameSize,
                      color: frame.c === 0 ? 'black' : 'white',
                      fontSize: frameSize * 0.3,
                      left: `${(i + 1) * xSpacing}px`,
                      top: `${(zSize - 1 - frame.z) * (frameSize + 30)}px`,
                    }}
                  >
                    <div>{i + 1}</div>
                    <div className="timepoint-label">
                      T{frame.t}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          // Frame Sequence Table
          <div>
            <h3>Frame Sequence on Disk</h3>
            <div className="sequence-table-container">
              <table className="sequence-table">
                <thead>
                  <tr>
                    <th>Frame #</th>
                    <th>Dimensions</th>
                  </tr>
                </thead>
                <tbody>
                  {sequence.map((frame, i) => (
                    <tr key={i}>
                      <td style={{fontWeight: '600'}}>{i+1}</td>
                      <td>
                        <span
                          className="frame-indicator"
                          style={{backgroundColor: channelColors[frame.c]}}
                        ></span>
                        Z{frame.z}-C{frame.c}-T{frame.t}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById('dimension-order-visualizer-root'));
  root.render(<DimensionOrderVisualizer />);
</script>
